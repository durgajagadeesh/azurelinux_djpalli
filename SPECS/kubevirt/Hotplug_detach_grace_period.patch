From ed0b1ecb84c0de69e7327dae6b8feee6abba551c Mon Sep 17 00:00:00 2001
From: Sharath Srikanth Chellappa <sharathsr@microsoft.com>
Date: Mon, 5 Aug 2024 11:45:42 -0700
Subject: [PATCH] Updating hotplugdetachmentGracePeriod patch with repeated lookups for disk detachment

---
 pkg/virt-launcher/virtwrap/manager.go | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/pkg/virt-launcher/virtwrap/manager.go b/pkg/virt-launcher/virtwrap/manager.go
index 63d8d43d29..d46a707df0 100644
--- a/pkg/virt-launcher/virtwrap/manager.go
+++ b/pkg/virt-launcher/virtwrap/manager.go
@@ -935,6 +935,31 @@ func (l *LibvirtDomainManager) SyncVMI(vmi *v1.VirtualMachineInstance, allowEmul
 			logger.Reason(err).Error("detaching device")
 			return nil, err
 		}
+		logger.V(1).Infof("Checking if disk %s, target %s is still attached", detachDisk.Alias.GetName(), detachDisk.Target.Device)
+		// Check if the disk is still attached
+		for i := 0; i < 5; i++ {
+			logger.V(1).Infof("Loop count: %d, domain name: %s", i, detachDisk.Alias.GetName())
+			dom, err = l.virConn.LookupDomainByName(domain.Spec.Name)
+			if err != nil {
+				logger.Reason(err).Error("getting domain after device detach")
+			}
+			// Check if the domain still has the detach disk name and detach disk target
+			xmlDesc, err := dom.GetXMLDesc(0)
+			if err != nil {
+				logger.Reason(err).Error("getting domain XML after device detach")
+			}
+
+			logger.V(1).Infof("Checking if disk %s, target %s is still present in the domain", detachDisk.Alias.GetName(), detachDisk.Target.Device)
+			logger.V(1).Infof("Domain XML: %s", xmlDesc)
+			if strings.Contains(xmlDesc, detachDisk.Alias.GetName()) && strings.Contains(xmlDesc, detachDisk.Target.Device) {
+				logger.V(1).Infof("Disk %s with target %s is still present in the domain", detachDisk.Alias.GetName(), detachDisk.Target.Device)
+			} else {
+				logger.V(1).Infof("Disk %s with target %s has been successfully detached", detachDisk.Alias.GetName(), detachDisk.Target.Device)
+				dom.Free()
+				break
+			}
+			time.Sleep(1 * time.Second)
+		}
 	}
 	// Look up all the disks to attach
 	for _, attachDisk := range getAttachedDisks(oldSpec.Devices.Disks, domain.Spec.Devices.Disks) {
-- 
2.45.2